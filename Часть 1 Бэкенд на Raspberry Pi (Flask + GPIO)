1.1 Установка зависимостей
bash
sudo apt-get update
sudo apt-get install python3-pip
sudo pip3 install flask flask-cors RPi.GPIO
1.2 Основной серверный скрипт (app.py)
python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import json
import time
import threading
from flask import Flask, jsonify, request, render_template
from flask_cors import CORS
import RPi.GPIO as GPIO

# Конфигурация GPIO
GPIO.setmode(GPIO.BOARD)
GPIO.setwarnings(False)

# Конфигурация пинов (настройте под свою схему)
PINS = {
    'led': 7,           # GPIO4 (пин 7)
    'relay': 11,        # GPIO17 (пин 11) для реле
    'buzzer': 13,       # GPIO27 (пин 13)
    'pir': 15,          # GPIO22 (пин 15) датчик движения
    'button': 16,       # GPIO23 (пин 16) кнопка
    'temp_sensor': 18   # GPIO24 (пин 18) для датчика температуры
}

# Состояния устройств
devices_state = {
    'led': False,
    'relay': False,
    'buzzer': False,
    'motion_detected': False,
    'temperature': 25.0,
    'system_status': 'online'
}

# Настройка Flask
app = Flask(__name__)
CORS(app)  # Разрешаем запросы с мобильного приложения

# Инициализация GPIO
def init_gpio():
    # Выходные пины
    for pin in ['led', 'relay', 'buzzer']:
        GPIO.setup(PINS[pin], GPIO.OUT)
        GPIO.output(PINS[pin], GPIO.LOW)
    
    # Входные пины
    GPIO.setup(PINS['pir'], GPIO.IN)
    GPIO.setup(PINS['button'], GPIO.IN, pull_up_down=GPIO.PUD_UP)
    
    print("GPIO инициализирован")

# Мониторинг датчика движения (в фоновом потоке)
def motion_monitor():
    while True:
        if GPIO.input(PINS['pir']):
            devices_state['motion_detected'] = True
            # Можно добавить уведомление через WebSocket или MQTT
        else:
            devices_state['motion_detected'] = False
        time.sleep(0.5)

# Мониторинг кнопки
def button_monitor():
    while True:
        if not GPIO.input(PINS['button']):  # Кнопка нажата
            # Переключаем светодиод при нажатии кнопки
            devices_state['led'] = not devices_state['led']
            GPIO.output(PINS['led'], devices_state['led'])
            print(f"Кнопка нажата, LED: {devices_state['led']}")
            time.sleep(0.5)  # Защита от дребезга
        time.sleep(0.1)

# Симуляция температуры (замените на реальный датчик DHT22/DS18B20)
def temperature_monitor():
    import random
    while True:
        devices_state['temperature'] = round(20 + random.uniform(0, 10), 1)
        time.sleep(5)

# API Endpoints
@app.route('/')
def index():
    return render_template('index.html')

@app.route('/api/status', methods=['GET'])
def get_status():
    return jsonify({
        'success': True,
        'devices': devices_state,
        'timestamp': time.time()
    })

@app.route('/api/device/<device_name>', methods=['GET', 'POST'])
def control_device(device_name):
    if device_name not in ['led', 'relay', 'buzzer']:
        return jsonify({'success': False, 'error': 'Устройство не найдено'}), 404
    
    if request.method == 'GET':
        return jsonify({
            'success': True,
            'device': device_name,
            'state': devices_state[device_name]
        })
    
    elif request.method == 'POST':
        data = request.get_json()
        if not data or 'state' not in data:
            return jsonify({'success': False, 'error': 'Не указано состояние'}), 400
        
        new_state = bool(data['state'])
        devices_state[device_name] = new_state
        
        # Управляем GPIO
        GPIO.output(PINS[device_name], GPIO.HIGH if new_state else GPIO.LOW)
        
        # Для пищалки делаем короткий сигнал
        if device_name == 'buzzer' and new_state:
            threading.Thread(target=beep_buzzer).start()
        
        return jsonify({
            'success': True,
            'device': device_name,
            'state': new_state,
            'message': f'Устройство {device_name} {"включено" if new_state else "выключено"}'
        })

@app.route('/api/all/on', methods=['POST'])
def all_on():
    for device in ['led', 'relay', 'buzzer']:
        devices_state[device] = True
        GPIO.output(PINS[device], GPIO.HIGH)
    
    # Для пищалки короткий сигнал
    threading.Thread(target=beep_buzzer, args=(0.2,)).start()
    
    return jsonify({
        'success': True,
        'message': 'Все устройства включены'
    })

@app.route('/api/all/off', methods=['POST'])
def all_off():
    for device in ['led', 'relay', 'buzzer']:
        devices_state[device] = False
        GPIO.output(PINS[device], GPIO.LOW)
    
    return jsonify({
        'success': True,
        'message': 'Все устройства выключены'
    })

@app.route('/api/pir/status', methods=['GET'])
def get_pir_status():
    current_state = bool(GPIO.input(PINS['pir']))
    devices_state['motion_detected'] = current_state
    
    return jsonify({
        'success': True,
        'motion_detected': current_state,
        'timestamp': time.time()
    })

@app.route('/api/system/restart', methods=['POST'])
def restart_system():
    # Здесь может быть команда перезагрузки
    # os.system('sudo reboot')
    
    return jsonify({
        'success': True,
        'message': 'Команда перезагрузки отправлена'
    })

# Вспомогательные функции
def beep_buzzer(duration=0.1):
    GPIO.output(PINS['buzzer'], GPIO.HIGH)
    time.sleep(duration)
    GPIO.output(PINS['buzzer'], GPIO.LOW)

# Обработка ошибок
@app.errorhandler(404)
def not_found(error):
    return jsonify({'success': False, 'error': 'Ресурс не найден'}), 404

@app.errorhandler(500)
def internal_error(error):
    return jsonify({'success': False, 'error': 'Внутренняя ошибка сервера'}), 500

# Запуск сервера
if __name__ == '__main__':
    try:
        init_gpio()
        
        # Запуск фоновых потоков
        threading.Thread(target=motion_monitor, daemon=True).start()
        threading.Thread(target=button_monitor, daemon=True).start()
        threading.Thread(target=temperature_monitor, daemon=True).start()
        
        print("Сервер запускается...")
        print("Доступные API endpoints:")
        print("  GET  /api/status          - Получить статус всех устройств")
        print("  GET  /api/device/<name>   - Получить статус устройства")
        print("  POST /api/device/<name>   - Управление устройством")
        print("  POST /api/all/on          - Включить все устройства")
        print("  POST /api/all/off         - Выключить все устройства")
        print("  GET  /api/pir/status      - Проверить датчик движения")
        
        app.run(host='0.0.0.0', port=5000, debug=False, threaded=True)
        
    except KeyboardInterrupt:
        print("\nСервер остановлен")
    finally:
        GPIO.cleanup()
1.3 HTML интерфейс (опционально, templates/index.html)
html
<!DOCTYPE html>
<html>
<head>
    <title>Raspberry Pi Control Panel</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .device {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
        }
        .on { background: #4CAF50; color: white; }
        .off { background: #f44336; color: white; }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .btn-on { background: #4CAF50; color: white; }
        .btn-off { background: #f44336; color: white; }
        .btn-all { background: #2196F3; color: white; }
    </style>
</head>
<body>
    <h1>Raspberry Pi Control Panel</h1>
    
    <div id="status" class="device">
        <h2>Статус системы</h2>
        <div id="statusInfo">Загрузка...</div>
    </div>
    
    <div class="device">
        <h2>Управление устройствами</h2>
        <button onclick="controlDevice('led', true)" class="btn-on">Включить LED</button>
        <button onclick="controlDevice('led', false)" class="btn-off">Выключить LED</button>
        
        <button onclick="controlDevice('relay', true)" class="btn-on">Включить Реле</button>
        <button onclick="controlDevice('relay', false)" class="btn-off">Выключить Реле</button>
        
        <button onclick="controlDevice('buzzer', true)" class="btn-on">Пискнуть</button>
        
        <br><br>
        <button onclick="controlAll(true)" class="btn-all">Включить все</button>
        <button onclick="controlAll(false)" class="btn-all">Выключить все</button>
    </div>
    
    <script>
        const API_BASE = 'http://' + window.location.hostname + ':5000/api';
        
        async function getStatus() {
            try {
                const response = await fetch(API_BASE + '/status');
                const data = await response.json();
                
                if (data.success) {
                    const statusDiv = document.getElementById('statusInfo');
                    statusDiv.innerHTML = `
                        <div class="status ${data.devices.system_status === 'online' ? 'on' : 'off'}">
                            Система: ${data.devices.system_status}
                        </div>
                        <div class="status ${data.devices.led ? 'on' : 'off'}">
                            LED: ${data.devices.led ? 'ВКЛ' : 'ВЫКЛ'}
                        </div>
                        <div class="status ${data.devices.relay ? 'on' : 'off'}">
                            Реле: ${data.devices.relay ? 'ВКЛ' : 'ВЫКЛ'}
                        </div>
                        <div class="status ${data.devices.motion_detected ? 'on' : 'off'}">
                            Движение: ${data.devices.motion_detected ? 'Обнаружено' : 'Нет'}
                        </div>
                        <div class="status">
                            Температура: ${data.devices.temperature}°C
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Ошибка:', error);
            }
        }
        
        async function controlDevice(device, state) {
            try {
                const response = await fetch(API_BASE + '/device/' + device, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ state: state })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert(data.message);
                    getStatus();
                }
            } catch (error) {
                console.error('Ошибка:', error);
            }
        }
        
        async function controlAll(state) {
            try {
                const endpoint = state ? '/all/on' : '/all/off';
                const response = await fetch(API_BASE + endpoint, {
                    method: 'POST'
                });
                
                const data = await response.json();
                if (data.success) {
                    alert(data.message);
                    getStatus();
                }
            } catch (error) {
                console.error('Ошибка:', error);
            }
        }
        
        // Обновляем статус каждые 2 секунды
        setInterval(getStatus, 2000);
        getStatus();
    </script>
</body>
</html>
